## 爱思商城开发文档

### 1. 基础设施的搭建

#### 1.1 Nacos（192.168.75.130）

- **安装**

```
git clone https://github.com/nacos-group/nacos-docker.git

cd /usr/local/docker/nacos-docker

docker-compose -f example/standalone-mysql.yaml up
```

- **访问**

```
http://192.168.75.130:8848/nacos/
默认账号密码为 nacos/nacos
```

#### 1.2 MySQL（192.168.75.136）

- **安装**

### 2. Thymeleaf

- **标签用法**

```
文本
th:text="${}"  

指定表单提交的路径
th:action="@{/test/hello}"     

循环
th:each="user,userSta:${userlist}"     
    th:text="${userSta.index}"      //状态记录
    th:text="${user.id}"
    th:text="${user.name}"
    
读取Map
1.知道Map的key，直接根据key获取数据
th:text="${dataMap.xxx}"
2.不知道Map的key,通过循环获取Map的key及其数据
th:each="map:${dataMap}"
    th:text="${map.key}"
    th:text="${map.value}"
    
日期数据获取
th:text="${#dates.format(now,'yyyy-MM-dd HH:mm:ss')}"

条件判断
th:if="${age>18}"           //条件成立时输出
th:unless="${age>18}"       //条件不成立是输出

定义一个模块
th:fragment="copy"
引入模块
th:include="footer::copy"
```

- **配置**

```
#缓存配置
spring.thymeleaf.cache: false
spring.thymeleaf.prefix
spring.thymeleaf.suffix   默认的前缀后缀
```

**后端人员写绝对路径就行**

### 3. OpenResty

#### 3.1 lua

#### 3.2 Nginx

##### 3.2.1 简介

Nginx是目前最火的负载均衡之一，在流量陡增的互联网面前，接口限流是很有必要的，尤其是针对高并发的场景。
Nginx的限流主要是两种方式：**限制访问频率**和**限制并发连接数**。

##### 3.2.2 限流设置

- **限制访问频率（正常流量）**

  Nginx中使用 `ngx_http_limit_req_module` 模块来限制请求的访问频率，基于**漏桶算法**原理实现。
  使用`nginx limit_req_zone`和`limit_req`两个指令限制单个IP的请求处理速率。

  **语法：limit_req_zone key zone rate**

  - **key**：定义限流对象。`binary_remote_addr`是一种key，表示基于 remote_addr(客户端IP)来做限流，`binary`的目的是压缩内存占用量。
  - **zone**：定义共享内存区来存储访问信息。`myRateLimit:10m`表示一个大小为10M，名字为myRateLimit的内存区域。
  - **rate**：设置最大访问速率。`rate=10r/s`表示每秒最多处理10个请求。Nginx 实际上以毫秒为粒度来跟踪请求信息，因此 10r/s 实际上是限制：每100毫秒处理一个请求。**这意味着**，自上一个请求处理完后，若后续100毫秒内又有请求到达，将拒绝处理该请求。

- **限制访问频率（突发流量）**

  按上面的配置在流量突然增大时，超出的请求将被拒绝，无法处理突发流量，那么在处理突发流量的时候，该怎么处理呢？

  Nginx提供了 burst 结合 nodelay 参数使用来解决突发流量的问题。

  **burst** 译为突发、爆发，**表示在超过设定的处理速率后能额外处理的请求数。**（需要等待）

  **burst=20 nodelay 表示20个请求立马处理，不延迟。**

  **注：** burst=20 相当于缓存队列中占了20个坑，即使这20个突发请求立马处理结束，后续请求也不会立马处理，因为这20个位置只能按 100ms一个来释放。因此就达到了速率稳定，突发流量也能正常处理的效果。

- **限制并发连接数**

  Nginx 的`ngx_http_limit_conn_module`模块提供了对资源连接数进行限制的功能，使用`limit_conn_zone`和`limit_conn`两个指令。

  - **limit_conn perip 20**：对应的key是 `$binary_remote_addr`，表示限制单个IP同时最多能持有20个连接。
  - **limit_conn perserver 100**：对应的key是 `$server_name`，表示虚拟主机(server) 同时能处理并发连接的总数。注意，只有当 request header 被后端server处理后，这个连接才进行计数。

  pid文件丢失。可以运行一下命令

  ```
  /usr/local/openresty/nginx/sbin/nginx -c /usr/local/openresty/nginx/conf/nginx.conf
  ```

### 4. Kibana---ES的数据分析工具

```
docker pull docker.io/kibana
docker run -it -d -e ELASTICSEARCH=http://192.168.75.148:9200 --name kibana --restart=always -p 5601:5601 kibana
```

### 5. 完整DSL语句代码

```
#查询所有索引
GET _cat/indices?v

#删除索引库
DELETE /user

#新增索引库
PUT /user

#创建映射
PUT /user/userinfo/_mapping
{
  "properties": {
    "name":{
      "type": "text",
      "analyzer": "ik_smart",
      "search_analyzer": "ik_smart", 
      "store": false
    },
    "city":{
      "type": "text",
      "analyzer": "ik_smart",
      "search_analyzer": "ik_smart", 
      "store": false
    },
    "age":{
      "type": "long",
      "store": false
    },
    "description":{
      "type": "text",
      "analyzer": "ik_smart",
      "search_analyzer": "ik_smart", 
      "store": false
    }
  }
}

#新增数据
PUT /user/userinfo/1
{
  "name": "张三",
  "age": "20",
  "city": "山东临沂",
  "description": "帅气"
}
PUT /user/userinfo/2
{
  "name": "李四",
  "age": "22",
  "city": "北京",
  "description": "漂亮"
}

#根据ID查询数据
GET /user/userinfo/1

#查询所有数据
GET /user/_serarch

#排序查询
GET /user/_search
{
  "query":{
    "match_all": {}
  },
  "sort": {
      "age":{
        "order":"desc"
    }
  }
}

#分页查询
GET /user/_search
{
  "query":{
    "match_all": {}
  },
  "from": 0,
  "size": 10
}

#更新数据（删除原始数据，新增数据）
PUT /user/userinfo/1
{
  "name": "张毅",
  "age": "30"
}

#更新数据（直接修改指定域数据）
POST /user/userinfo/1
{
  "doc":{
    "name": "张四",
    "city": "南京"
  }
}

#删除数据
DELETE /user/userinfo/1

#词项搜索term
GET /user/_search
{
  "query": {
    "term": {
      "city": {
        "value": "北京"
      }
    }
  }
}

#多个词项搜索terms
GET /user/_search
{
  "query":{
    "terms": {
      "city": [
        "北京",
        "南京"
      ]
    }
  }
}

#范围过滤搜索
GET /user/_search
{
  "query": {
    "range": {
      "age": {
        "gte": 10,
        "lte": 30
      }
    }
  }
}

#查询存在某个域的数据
GET /user/_search
{
  "query": {
    "exists":{
      "field": "age"
    }
  }
}

#组合查询bool
GET /user/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "city": {
              "value": "北京"
            }
          }
        },
        {
          "range": {
            "age": {
              "gte": 10,
              "lte": 30
            }
          }
        }
      ]
    }
  }
}

#查询所有
GET /user/_search
{
  "query": {
    "match_all": {}
  }
}

#macth查询
GET /user/_search
{
  "query": {
    "match": {
      "description": "漂亮"
    }
  }
}

#前缀搜索prefix
GET /user/_search
{
  "query": {
    "prefix": {
      "name": {
        "value": "李"
      }
    }
  }
}

#多个域匹配
GET /user/_search
{
  "query": {
    "multi_match": {
      "query": "北京",
      "fields": [
        "city",
        "description"
      ]
    }
  }
}
```

### 6. IK分词器

- 自定义分词器的配置

- 自定义停用词汇

### 7. Elasticsearch

```
docker pull elasticsearch

docker run -di --name Elasticsearch -p 9200:9200 -p 9300:9300 elasticsearch

9200：Web管理平台端口
9300：服务默认端口
```

开启远程连接

```

```

系统参数配置

小提示: 容器开启重启

```
docker update --restart=always 容器名称或CID
```

IK分词器下载

releases下载失败

可以下载源码 zip

如果选择下载源码然后自己编译的话，使用maven进行编译： 在该目录下，首先执行：

```
mvn compile
```

会生成一个target目录，然后执行

```
mvn package
```

会在target目录下生成一个releases目录，在该目录下有一个压缩包，这就是编译好的，与直接下载编译好是一样的~

或者把该项目在IDEA打开，在客户端执行maven的clear、compile和package命令，效果都是一样的，但是用命令行编译好像稍微快一点

### 8. FastDFS

### 9. OSS

### 10. Canal-数据同步

### 11. Jwt令牌

- **生成私钥公钥**

  **JWT令牌生成采用非对称加密算法**

  1.生成密钥证书 下边命令生成密钥证书，采用RSA 算法每个证书包含公钥和私钥

  ```
  keytool -genkeypair -alias acemall -keyalg RSA -keypass jerusalem -keystore ace-mall.jks -storepass jerusalem 
  ```

  Keytool 是一个java提供的证书管理工具

  ```
  -alias：证书的别名 
  -keyalg：使用的hash算法
  -keypass：密钥的访问密码
  -keystore：密钥库文件名
  -storepass：密钥库的访问密码
  ```

  查询证书信息：

  ```
  keytool -list -keystore ace-mall.jks
  ```

  2.导出公钥 openssl是一个加解密工具包，这里使用openssl来导出公钥信息。

  [安装地址](http://slproweb.com/products/Win32OpenSSL.html)

  安装资料目录下的Win64OpenSSL-1_1_1b.exe

- **配置openssl的path环境变量**

cmd进入changgou.jks文件所在目录执行如下命令：

```
keytool -list -rfc --keystore ace-mall.jks | openssl x509 -inform pem -pubkey
```

将公钥拷贝到文本public.key文件中，合并为一行,可以将它放到需要实现授权认证的工程中。

### 12. 解决跨域问题

- 使用nginx部署为同一域 

- 配置为允许跨域